# Система очереди покупок

## Описание

Реализована система очереди, позволяющая пользователям покупать лоты с 0 аккаунтами и автоматически получать их при пополнении лота администратором.

## Новые возможности

### 1. Покупка лотов с 0 аккаунтами

- ✅ Пользователи теперь могут оплачивать лоты, даже если в них закончились аккаунты
- ✅ После оплаты пользователь автоматически встает в очередь
- ✅ Поддерживается как оплата в USDT через CryptoBot, так и рублевые платежи

### 2. Автоматические уведомления админу

- ✅ При истощении лота админ получает уведомление
- ✅ В уведомлении указывается размер очереди ожидающих покупателей
- ✅ Приоритетные уведомления для лотов с оплаченными заказами в очереди

### 3. Автоматическая выдача при пополнении

- ✅ При добавлении новых логов в лот автоматически обрабатывается очередь
- ✅ Оплаченные заказы имеют приоритет
- ✅ Аккаунты выдаются в порядке оплаты (FIFO)

### 4. Обновленный интерфейс

- ✅ Лоты с 0 аккаунтами отображаются как "ОЧЕРЕДЬ"
- ✅ Показывается количество людей в очереди
- ✅ Информативные сообщения при постановке в очередь

## Техническая реализация

### Новая таблица `purchase_queue`

```sql
CREATE TABLE purchase_queue (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    account_id INTEGER NOT NULL,
    payment_type TEXT NOT NULL,        -- 'crypto' или 'rub'
    price_usdt REAL NOT NULL,
    price_rub INTEGER,                 -- для рублевых платежей
    username TEXT,
    invoice_id TEXT,                   -- для крипто-платежей
    payment_status TEXT DEFAULT 'pending', -- 'pending', 'paid', 'fulfilled'
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Новые методы Database

- `add_to_purchase_queue()` - добавление в очередь
- `get_queue_size()` - размер очереди для лота
- `get_next_from_queue()` - получение следующего в очереди
- `mark_queue_entry_fulfilled()` - отметка выполнения
- `update_queue_payment_status()` - обновление статуса оплаты
- `process_queue_for_lot()` - обработка очереди при пополнении

### Обновленные функции

- `mark_account_sold()` - теперь возвращает информацию об истощении лота
- `handle_crypto_purchase()` - поддержка очереди
- `handle_rub_purchase()` - поддержка очереди
- `check_payment_status()` - интеграция с очередью
- `add_credential()` - автоматическая обработка очереди

## Логика работы

### Сценарий 1: Покупка лота с доступными аккаунтами
1. Пользователь выбирает лот с аккаунтами > 0
2. Обычный процесс оплаты и получения

### Сценарий 2: Покупка лота с 0 аккаунтов
1. Пользователь выбирает лот с 0 аккаунтов
2. Создается invoice/заказ как обычно
3. Пользователь добавляется в очередь со статусом "pending"
4. После оплаты статус обновляется на "paid"
5. При пополнении лота автоматически выдается аккаунт

### Сценарий 3: Пополнение лота с очередью
1. Админ добавляет новые логи в лот
2. Система автоматически обрабатывает очередь
3. Оплаченные заказы получают аккаунты в порядке очереди
4. Отправляются уведомления пользователям
5. Записи в очереди помечаются как "fulfilled"

## Приоритеты в очереди

1. **Оплаченные заказы** (payment_status = "paid") - высший приоритет
2. **Неоплаченные заказы** (payment_status = "pending") - обрабатываются только если оплачены

Внутри каждой группы - порядок по времени создания (FIFO).

## Уведомления

### Админу при истощении лота:
- Название и ID лота
- Количество людей в очереди
- Призыв к пополнению (если очередь не пуста)

### Пользователю при постановке в очередь:
- Номер в очереди
- Объяснение процесса
- Гарантия автоматической выдачи

### Пользователю при получении из очереди:
- Стандартное сообщение о получении аккаунта
- Данные для входа

## Совместимость

Все существующие функции продолжают работать как раньше. Система очереди активируется только для лотов с 0 аккаунтов.